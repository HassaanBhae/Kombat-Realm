<!DOCTYPE html>
<html>
<head>
<style>
body{
    background-color:#271408;
    margin: 0;
    overflow: hidden;
    background-image: url(./Dojo.webp);
    background-repeat: no-repeat;
}
#indicator{
    position: absolute;
    scale: 3;
    margin-left: 400px;
    margin-top: 600px;
    color: blueviolet;
}
#player,
#Attack1,
#Attack2,
#Attack3,
#Attack4,
#fall,
.run{
    position: absolute;
    display:none;
    scale: 3;
}

</style>
</head>
<body>

<p id="p" style="position: absolute;margin-left: 10px;border: 2px black solid;">A canvas element is displayed like this:</p>
<p id="p2" style="position: absolute;margin-right:10px;right: 0;border: 2px black solid;">A canvas element is displayed like this:</p>
<img id="player" src="./Idle.png">
<img id="Attack1" src="./attack/Attack1.png">
<img id="Attack2" src="./attack/Attack2.png">
<img id="Attack3" src="./attack/Attack3.png">
<img id="Attack4" src="./attack/Attack4.png">
<img id="Run0" class="run" src="./run/Run_0.png">
<img id="Run1" class="run" src="./run/Run_1.png">
<img id="Run2" class="run" src="./run/Run_2.png">
<img id="Run3" class="run" src="./run/Run_3.png">
<img id="Run4" class="run" src="./run/Run_4.png">
<img id="Run5" class="run" src="./run/Run_5.png">
<img id="Run6" class="run" src="./run/Run_6.png">
<img id="Run7" class="run" src="./run/Run_7.png">
<img id="fall" src="./fall/Fall.png">

<h2 id="indicator"></h2>
<canvas id="canvas" style="width: 100vw; height: 100vh;">Your browser does not support the HTML5 canvas tag.</canvas>
<button id="button">Press</button>
<script>
    let canvas;
    let context;
    let x,y;
    const keysPressed = new Set(); // Track keys pressed
    const scale = 3; // Set your scale factor here
    const pwidth = 50 * scale; // Scaled width
    const pheight = 61 * scale; // Scaled height
    const pawidth = 100 * scale; // Scaled width
    const paheight = 70 * scale; // Scaled height
    let moveFrameCounter = 0;  // Keeps track of the current frame

    function User(name,x,y) {
        this.name = name;
        this.health = 100;
        this.x = x;
        this.y = y;
        this.attacking = false;
        let isAtAttackF1 = false; // Flag to track jumping state
        let isAtAttackF2 = false; // Flag to track jumping state
        let isAtAttackF3 = false; // Flag to track jumping state
        let isAtAttackF4 = false; // Flag to track jumping state

        let isMoving = false;
        let isJumping = false; // Flag to track jumping state
        let isFalling = false; // Flag to track jumping state
        let isDashing = false; // Flag to track jumping state
        this.takeDamage = function(damage) {
            this.health -= damage;
        };
        this.attack = function(){
            this.isAttacking = true;
            attackAnimation(this.x,this,y);
            // checkHealth();
            setTimeout(() => {
                this.isAttacking = false;
            }, 800); 
        }
        this.move = function(){
            moveAnimation(this.x,this.y);
        };
        this.jump = function(){
            this.isJumping = true; // Set jumping state
            let counter = 0;
            const intervalId = setInterval(() => {
                if (counter < 50) { // Number of upward moves for the jump
                    this.y -= 6; // Move up gradually
                    counter++;
                } else {
                    clearInterval(intervalId); // Stop the upward movement
                    this.fall(); // Start falling back down
                }
            }, 1);
        };
        this.fall = function(){
            console.log('Falling!');
            this.isFalling = true;
            fallAnimation(this.x,this.y);
            // console.log("Fall ANimation Ended");
            let fallCounter = 0;
            const fallIntervalId = setInterval(() => {
                if (fallCounter < 50) { // Number of downward moves
                    this.y += 6; // Move down gradually
                    fallCounter++;
                } else {
                    clearInterval(fallIntervalId); // Stop the downward movement
                    this.isJumping = false; // Reset jumping state
                    this.isFalling = false;
                }
            }, 1);
        }
        this.dash = function(){
            // If dash is on cooldown, return early
            if (this.isDashing === true) {
                return;
            }
            this.isDashing = true; // Set dashing state
            playingAnimation=true;
            this.x += 300; // Move player position to the right
            this.attack();
            setTimeout(() => {
                this.x -= 300; // Reset the player position after the dash
                playingAnimation = false; // Animation ends
            }, 250);
            setTimeout(() => {
                this.isDashing = false; // Reset cooldown after 3 seconds
            }, 300); // Increased cooldown to ensure the dash cooldown is longer than the dash duration
        }
    }
    const player = new User('player',130,275);
    const enemy = new User('enemy',500,275);

    window.onload = init;

    function init() {
        canvas = document.getElementById('canvas');
        btn = document.getElementById('button');
        p = document.getElementById('p');
        p2 = document.getElementById('p2');
        context = canvas.getContext('2d');
        playerimg = document.getElementById("player");
        indicator = document.getElementById("indicator");
        playerAttackF1 = document.getElementById("Attack1");
        playerAttackF2 = document.getElementById("Attack2");
        playerAttackF3 = document.getElementById("Attack3");
        playerAttackF4 = document.getElementById("Attack4");
        fallF = document.getElementById("fall");
        moveF = document.querySelectorAll(".run");
        console.log('moveFrames: ', moveF);
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        // Track keydown and keyup events
        window.addEventListener('keydown', (event) => {
            keysPressed.add(event.key);
        });
        window.addEventListener('keyup', (event) => {
            keysPressed.delete(event.key);
        });
        btn.addEventListener('click', (event) =>{
            y -= 20;  
            setTimeout(() => {
                y +=20;
            }, 1000);
        });
        // Start the game loop
        window.requestAnimationFrame(gameLoop);

        setInterval(() => {
            if(player.isMoving){
                moveFrameCounter = (moveFrameCounter + 1) % 8;  // Cycle through 8 frames
                console.log(moveFrameCounter);
            }
            
        }, 50);
    }

    function gameLoop(timeStamp) {
        // Clear the canvas for each frame
        context.clearRect(0, 0, canvas.width, canvas.height);
        updatePosition(); // Update position based on keys pressed
        checkHealth();
        if (player.isAtAttackF1){
            drawAttack1(player.x,player.y);
            draw(enemy.x, enemy.y); // Draw the player image during normal movement

        }
        else if (player.isAtAttackF2) {
            drawAttack2(player.x,player.y); // Draw the attack image only during dash
            draw(enemy.x, enemy.y); // Draw the player image during normal movement

        }
        else if (player.isAtAttackF3) {
            drawAttack3(player.x,player.y); // Draw the attack image only during dash
            draw(enemy.x, enemy.y); // Draw the player image during normal movement

        }
        else if (player.isAtAttackF4) {
            drawAttack4(player.x,player.y);
            draw(enemy.x, enemy.y); // Draw the player image during normal movement

        }
        else if (player.isMoving && !player.isAttacking) {
            player.move();
            draw(enemy.x, enemy.y); // Draw the player image during normal movement
            
        } 
        else if (player.isFalling) {
            drawFall(player.x, player.y); // Draw the player image during normal movement
            draw(enemy.x, enemy.y); // Draw the player image during normal movement
        } 
        else {
            draw(player.x, player.y); // Draw the player image during normal movement
            draw(enemy.x, enemy.y); // Draw the player image during normal movement
        }
        window.requestAnimationFrame(gameLoop); // Keep requesting new frames
    }
    function updatePosition() {
        if (keysPressed.has('ArrowRight') && player.x<(canvas.width-pwidth) && !playingAnimation){
            player.x += 10;
        }
        if (keysPressed.has('ArrowLeft') && player.x>0 && !playingAnimation) {
            player.x -= 10;         
        }
        if (keysPressed.has('ArrowLeft') || keysPressed.has('ArrowRight')) {
            player.isMoving = true;
        }
        else{
            player.isMoving = false;
        } 
        if (keysPressed.has('ArrowLeft') && keysPressed.has('ArrowRight')) {
            player.isMoving = false;
        }
        if (keysPressed.has('ArrowDown') && !playingAnimation && !player.isAttacking) player.attack();
        if (keysPressed.has('ArrowUp') && !player.isJumping) player.jump();
        if (keysPressed.has(' ') && !player.isDashing && !player.isAttacking) player.dash();
        if (keysPressed.has('Enter') && !player.isJumping) player.jump(); // Only jump if not already jumping
    }

    let playingAnimation = false; //



    function checkHealth(){
        indicator.innerText = enemy.health;
        if(enemy.health <= 0){
            console.log("Enemy Dead");
            indicator.innerText = "Enemy Dead";
        }
    }

    function attackAnimation(x,y) {
        player.isAtAttackF1 = true;
        enemy.takeDamage(50);

        setTimeout(() => {
            player.isAtAttackF1 = false;
            player.isAtAttackF2 = true; 
        }, 140); 
        // Transition to point 3
        setTimeout(() => {
            player.isAtAttackF2 = false;
            player.isAtAttackF3 = true;
        }, 190);
        setTimeout(() => {
            player.isAtAttackF3 = false;
            player.isAtAttackF4 = true;
        }, 240);
        // Attack Timeout
        setTimeout(() => {
            player.isAtAttackF4 = false;
        }, 300);
    }
    function moveAnimation(x,y) {
        drawMove(moveF[moveFrameCounter],x,y);
    }
    function fallAnimation(x,y) {
        drawFall(x,y);
    }




    function draw(x, y) {
        // console.log('draw: ', draw);
        p.innerText = " x: "+player.x+" | y: "+player.y; // Display current x and y positions
        p2.innerText = " x: "+enemy.x+" | y: "+enemy.y; // Display current x and y positions
        context.drawImage(playerimg, x, y,pwidth,pheight); // Draw the scaled image
    }
    function drawAttack1(x, y) {
        p.innerText = " x: "+x+" | y: "+y; // Display current x and y positions
        y=y-(4  *scale);
        context.drawImage(playerAttackF1, x, y,pwidth,pheight); // Draw the scaled image
    }
    function drawAttack2(x, y) {
        p.innerText = " x: "+x+" | y: "+y; // Display current x and y positions
        y=y+(6  *scale);
        context.drawImage(playerAttackF2, x, y,pwidth,pwidth); // Draw the scaled image
    }
    function drawAttack3(x, y) {
        p.innerText = " x: "+x+" | y: "+y; // Display current x and y positions
        y=y-(15*scale);
        context.drawImage(playerAttackF3, x, y,pawidth,paheight); // Draw the scaled image
    }
    function drawAttack4(x, y) {
        p.innerText = " x: "+x+" | y: "+y; // Display current x and y positions
        y=y-(15*scale);
        context.drawImage(playerAttackF4, x, y,pawidth,paheight); // Draw the scaled image
    }
    function drawMove(img,x,y){
        p.innerText = " x: "+x+" | y: "+y;
        context.drawImage(img, x, y,pwidth,pheight); // Draw the scaled image
    }
    function drawFall(x,y){
        p.innerText = " xx: "+x+" | yx: "+y;
        context.drawImage(fallF, x, y,pwidth,pheight); // Draw the scaled image
    }


</script>

</body>
</html>
