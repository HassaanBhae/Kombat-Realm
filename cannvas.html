<!DOCTYPE html>
<html>
<head>
<style>
/* canvas {
  border:1px solid black;
} */
body{
    background-color:#271408;
    margin: 0;
    overflow: hidden;
    background-image: url(./Dojo.webp);
    background-repeat: no-repeat;
}
#player{
    position: absolute;
    display:none;
    /* background-color: aqua; */
    /* height: 100px; */
    scale: 3;
}
#Attack1{
    position: absolute;
    display:none;
    /* background-color: aqua; */
    /* height: 100px; */
    scale: 3;
}
#Attack2{
    position: absolute;
    display:none;
    /* background-color: aqua; */
    /* height: 100px; */
    scale: 3;
}
#Attack3{
    position: absolute;
    display:none;
    /* background-color: aqua; */
    /* height: 100px; */
    scale: 3;
}
</style>
</head>
<body>

<p id="p" style="position: absolute;margin-left: 10px;border: 2px black solid;">A canvas element is displayed like this:</p>
<img id="player" src="./Idle.png">
<img id="Attack1" src="./Attack1.png">
<img id="Attack2" src="./Attack2.png">
<img id="Attack3" src="./Attack3.png">
<canvas id="canvas" style="width: 100vw; height: 100vh;">Your browser does not support the HTML5 canvas tag.</canvas>
<button id="button">Press</button>
<script>
    let canvas;
    let context;
    let x = 130; // x position
    let y = 275; // y position
    const keysPressed = new Set(); // Track keys pressed
    const scale = 3; // Set your scale factor here
    const pwidth = 50 * scale; // Scaled width
    const pheight = 61 * scale; // Scaled height
    const pawidth = 100 * scale; // Scaled width
    const paheight = 70 * scale; // Scaled height

    function User(name) {
        this.name = name;
        this.health = 100;
        this.takeDamage = function(damage) {
            this.health -= damage;
        };
    }
    const player = new User('player');
    const enemy = new User('enemy');


    window.onload = init;

    function init() {
        canvas = document.getElementById('canvas');
        btn = document.getElementById('button');
        p = document.getElementById('p');
        context = canvas.getContext('2d');
        playerimg = document.getElementById("player");
        playerAttack1 = document.getElementById("Attack1");
        playerAttack2 = document.getElementById("Attack2");
        playerAttack3 = document.getElementById("Attack3");
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        // Track keydown and keyup events
        window.addEventListener('keydown', (event) => {
            keysPressed.add(event.key);
            console.log(event.code);
        });
        window.addEventListener('keyup', (event) => keysPressed.delete(event.key));

        btn.addEventListener('click', (event) =>{
            y -= 20;  
            setTimeout(() => {
                y +=20;
            }, 1000);
        });

        // Start the game loop
        window.requestAnimationFrame(gameLoop);
    }

    function gameLoop(timeStamp) {
        // Clear the canvas for each frame
        context.clearRect(0, 0, canvas.width, canvas.height);
        updatePosition(); // Update position based on keys pressed
        if (isAtDashPoint1){
            drawAttack1(x,y);
        }
        else if (isAtDashPoint2) {
            drawAttack2(x, y); // Draw the attack image only during dash
        }
        else if (isAtDashPoint3) {
            drawAttack3(x, y); // Draw the attack image only during dash
        } else {
            draw(x, y); // Draw the player image during normal movement
        }
        window.requestAnimationFrame(gameLoop); // Keep requesting new frames
    }
    function updatePosition() {
        // Update x and y based on keys pressed
        if (keysPressed.has('ArrowRight') && x<(canvas.width-pwidth) && !playingAnimation) x += 5;
        if (keysPressed.has('ArrowLeft') && x>0 && !playingAnimation) x -= 5;

        if (keysPressed.has('ArrowDown') && !playingAnimation && !isAttacking) attack();
        if (keysPressed.has('ArrowUp') && !isJumping) jump();
        if (keysPressed.has(' ') && !isDashing ) dash();
        if (keysPressed.has('Enter') && !isJumping) jump(); // Only jump if not already jumping
    }

    let playingAnimation = false; //
    let isJumping = false; // Flag to track jumping state
    let isDashing = false; // Flag to track jumping state
    let isAttacking = false; // Flag to track jumping state
    let isAtDashPoint1 = false; // Flag to track jumping state
    let isAtDashPoint2 = false; // Flag to track jumping state
    let isAtDashPoint3 = false; // Flag to track jumping state


    function jump() {
        isJumping = true; // Set jumping state
        let counter = 0;
        const intervalId = setInterval(() => {
            if (counter < 50) { // Number of upward moves for the jump
                y -= 6; // Move up gradually
                counter++;
            } else {
                clearInterval(intervalId); // Stop the upward movement
                fall(); // Start falling back down
            }
        }, 1);
    }
    function fall() {
        let fallCounter = 0;
        const fallIntervalId = setInterval(() => {
            if (fallCounter < 50) { // Number of downward moves
                y += 6; // Move down gradually
                fallCounter++;
            } else {
                clearInterval(fallIntervalId); // Stop the downward movement
                isJumping = false; // Reset jumping state
            }
        }, 1);
    }
    function attack(){
        isAttacking = true;
        attackAnimation();
        enemy.takeDamage(50);
        if(enemy.health <= 0){
            console.log("Enemy Dead");
        }
        setTimeout(() => {
            isAttacking = false;
        }, 800); 
    }
    function dash() {
        // If dash is on cooldown, return early
        if (isDashing === true) {
            return;
        }
        isDashing = true; // Set dashing state
        playingAnimation=true;
        x += 300; // Move player position to the right
        attackAnimation();
        setTimeout(() => {
            x -= 300; // Reset the player position after the dash
            playingAnimation = false; // Animation ends
        }, 250);
        setTimeout(() => {
            isDashing = false; // Reset cooldown after 3 seconds
        }, 300); // Increased cooldown to ensure the dash cooldown is longer than the dash duration
    }
    function attackAnimation() {
        // Start at dash point 1
        isAtDashPoint1 = true;
        // Transition to point 2
        setTimeout(() => {
            isAtDashPoint1 = false;
            isAtDashPoint2 = true; // Move to dash point 2
        }, 140); 
        // Transition to point 3
        setTimeout(() => {
            isAtDashPoint2 = false;
            isAtDashPoint3 = true; // Move to dash point 3
        }, 190);
        // After the dash, reset the player position
        setTimeout(() => {
            isAtDashPoint3 = false;
        }, 250);
    }

    function draw(x, y) {
        p.innerText = " x: "+x+" | y: "+y; // Display current x and y positions
        // context.fillStyle = "blue";
        // context.fillStyle. =""
        context.drawImage(playerimg, x, y,pwidth,pheight); // Draw the scaled image
        // context.fillRect(x, y, 50, 100); // Draw the square at the new position
    }
    function drawAttack1(x, y) {
        p.innerText = " x: "+x+" | y: "+y; // Display current x and y positions
        y=y-(4  *scale);
        context.drawImage(playerAttack1, x, y,pwidth,pheight); // Draw the scaled image
    }
    function drawAttack2(x, y) {
        p.innerText = " x: "+x+" | y: "+y; // Display current x and y positions
        y=y+(6  *scale);
        context.drawImage(playerAttack2, x, y,pwidth,pwidth); // Draw the scaled image
    }
    function drawAttack3(x, y) {
        p.innerText = " x: "+x+" | y: "+y; // Display current x and y positions
        y=y-(15*scale);
        context.drawImage(playerAttack3, x, y,pawidth,paheight); // Draw the scaled image
    }


</script>

<!-- <p>Change the default CSS settings to see the effect.</p> -->

</body>
</html>
